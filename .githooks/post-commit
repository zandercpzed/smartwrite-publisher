#!/bin/bash

# =============================================================================
# SmartWrite Publisher - Post-Commit Hook
# Executa rotina COMPLETA de versionamento após cada commit
# =============================================================================

set -e

SCRIPT_DIR="$( cd "$( dirname "${BASH_SOURCE[0]}" )" && pwd )"
PROJECT_ROOT="$( dirname "$SCRIPT_DIR" )"

cd "$PROJECT_ROOT"

# Colors
BLUE='\033[0;34m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
RED='\033[0;31m'
NC='\033[0m'

# Check if code changed (not just docs)
git diff --cached --name-only | grep -q "^src/" || {
  # Apenas docs mudaram, pular hook
  exit 0
}

echo -e "${BLUE}[Post-Commit Hook] Iniciando rotina automática de release...${NC}"

# 1. BUILD & VAULT SYNC
echo -e "${BLUE}[1] Building and syncing to Obsidian vault...${NC}"
if ! npm run build > /tmp/build.log 2>&1; then
  echo -e "${RED}✗ Build falhou!${NC}"
  cat /tmp/build.log
  exit 0  # Não interrompe o commit, mas avisa
fi
echo -e "${GREEN}✓ Build and vault sync successful${NC}"

# 2. BACKUP
echo -e "${BLUE}[2] Creating backup...${NC}"
CURRENT_VERSION=$(jq -r '.version' manifest.json)
BACKUP_DIR=".backups"
mkdir -p "$BACKUP_DIR"
BACKUP_FILE="$BACKUP_DIR/smartwrite-publisher-v${CURRENT_VERSION}-$(date +%Y%m%d_%H%M%S).tar.gz"
tar -czf "$BACKUP_FILE" \
  --exclude=node_modules \
  --exclude=.git \
  --exclude=dist \
  --exclude=main.js \
  --exclude=.obsidian \
  src/ manifest.json package.json README.md CHANGELOG.md esbuild.config.mjs tsconfig.json 2>/dev/null || true
echo -e "${GREEN}✓ Backup created: $(basename $BACKUP_FILE)${NC}"

# 3. INCREMENT VERSION
echo -e "${BLUE}[3] Incrementing version...${NC}"
IFS='.' read -r MAJOR MINOR PATCH <<< "$CURRENT_VERSION"
NEW_PATCH=$((PATCH + 1))
NEW_VERSION="$MAJOR.$MINOR.$NEW_PATCH"

# Update manifest.json
jq --arg version "$NEW_VERSION" '.version = $version' manifest.json > /tmp/manifest.json.tmp
mv /tmp/manifest.json.tmp manifest.json

# Update package.json
jq --arg version "$NEW_VERSION" '.version = $version' package.json > /tmp/package.json.tmp
mv /tmp/package.json.tmp package.json

echo -e "${GREEN}✓ Version incremented: ${CURRENT_VERSION} → ${NEW_VERSION}${NC}"

# 4. UPDATE DOCUMENTATION
echo -e "${BLUE}[4] Updating documentation...${NC}"

# Update .release-history.json
jq --arg version "$NEW_VERSION" \
   --arg date "$(date -u +%Y-%m-%dT%H:%M:%SZ)" \
   '.lastRelease = $version | .lastReleaseDate = $date | .nextTarget = ($version | split(".") as $v | $v[0] + "." + $v[1] + "." + ($v[2] | tonumber + 1 | tostring) | join("."))' \
   .release-history.json > /tmp/release-history.json.tmp
mv /tmp/release-history.json.tmp .release-history.json

echo -e "${GREEN}✓ Documentation updated${NC}"

# 5. STAGE AND COMMIT VERSIONING CHANGES
echo -e "${BLUE}[5] Committing version bump...${NC}"
git add manifest.json package.json .release-history.json "$BACKUP_FILE"
git commit -m "chore: Version bump ${CURRENT_VERSION} → ${NEW_VERSION}

- Created backup: $(basename $BACKUP_FILE)
- Updated manifest.json, package.json
- Updated .release-history.json

Co-Authored-By: SmartWrite Release Bot <release@smartwrite-publisher.dev>" \
  --no-verify || echo -e "${YELLOW}⚠ Already up to date${NC}"

echo -e "${BLUE}[6] Pushing to GitHub...${NC}"
if git push origin main 2>/dev/null; then
  echo -e "${GREEN}✓ Pushed to GitHub${NC}"
else
  echo -e "${YELLOW}⚠ Push failed (network/auth). Changes committed locally.${NC}"
fi

echo -e "${GREEN}=== Rotina automática completa! ===${NC}"
echo -e "Versão: ${YELLOW}${NEW_VERSION}${NC}"
echo -e "Backup: ${YELLOW}$(basename $BACKUP_FILE)${NC}"
